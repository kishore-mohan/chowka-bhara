<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Chowka Bhara - ಚೌಕಬಾರ</title>
    <link type="text/css" rel="stylesheet" href="main.css" media="screen">
    <link href="emoticons.css" rel="stylesheet" type="text/css"/>
    <script type="text/javascript" src="emoticons.js"></script>
    <script type="text/javascript" src="jquery.min.js"></script>
    <script type="text/javascript" src="jquery.url.js"></script>
    <script src="nowjs/now.js"></script>
    <script src="raphael.js" type="text/javascript" charset="utf-8"></script>
    <script src="cb.js" type="text/javascript" charset="utf-8"></script>
    <script src="jquery_popup.js" type="text/javascript" charset="utf-8"></script>
    <!--<link type="text/css" href='/bootstrap/css/bootstrap.min.css'>-->
    <!--<link type="text/css" href='/bootstrap/css/bootstrap-responsive.min.css'>-->
    <!--<link type="text/css" href='/stylesheets/style.css'>-->
    <!--<script src='http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js'></script>-->
    <!--<script src='/bootstrap/js/bootstrap.min.js'></script>-->
    <script type="text/javascript">
        var moderator = 0, client = 0;
        var is_moderator = false;

        function refresh_users_list(){
            // get all group users and populate the list
            now.getGroupUsers(function(users){
                var users_list = " | ";
                $.each(users, function(key, user){
                    if(is_moderator && user != moderator){
                        now.getUserNameById(user, function(name){
                            users_list += "<a class='menu_item' href='#' user_id='" +
                                    user + "' id='" + user + "'>remove " +
                                    name.substring(0, 10) + "</a>&nbsp;&nbsp;";
                            $("#users_list").html(users_list);
                        });
                    }
                });
            });
        }

        $("#users_list a").live('click', function(){
            var user_id = $(this).attr('user_id');
            var link_id = '#' + $(this).attr('id');
            now.getUserNameById(user_id, function(name){
                now.distributeGamePlay(name + " was removed from this room by Moderator");
                now.removeUserByModerator(user_id, function(user_id){
                    $(link_id).hide(400);
                });
            });
        });

        $("#leave_room").live('click', function(){
            now.distributeGamePlay(now.name + " left the room");
            now.leaveRoom(function(){
                var a = confirm("Are you sure?");
                if (a == true){
                    window.location = "/";
                }
            });
        });

        $("#lock_room").live('click', function(){
            var link_id = '#' + $(this).attr('id');
            now.lockRoom(function(is_locked){
                if(is_locked){
                    $(link_id).hide(400);
                    now.distributeGamePlay(now.name + " locked the room");
                    alert("Room Locked");
                }else{
                    alert("Not enough players to Lock the room");
//                    $('#menu_messages').html("Not enough players to Lock the room<br/>");
                    setTimeout(function(){
                        $('#menu_messages').html("");
                    },5000);
                }
            });
        });

        $("#help_div").live('click', function(){
            $.get('README', function(data) {
                $("#contactArea").html($(data));
                loadPopup();
                centerPopup();
            });
        });

        $("#help_close_link").live('click', function(){
            disablePopup();
        });

        $(document).ready(function(){
            now.ready(function(){
                var room = $.url().param('room');
                now.name = prompt("And you are...?", "Guest" + new Date().getTime());
                // place the current user in the game room
                now.changeRoom(room, function(success){
                    if(!success)
                        window.location = "/"; // room locked, redirect back
                    else{
                        // appoint a moderator for the current game room
                        now.groupModerator(function(moderator_id){
                            moderator = moderator_id;
                            now.userClientId(function(client_id){
                                client = client_id;
                                var load_msg = "<b style='font-size: 12px'>"+now.name+"</b>" + " joins the game";
                                if(client == moderator){
                                    load_msg += " as moderator";
                                    is_moderator = true;
                                    $("#moderator_menu").show(400);
                                    $("#role_dice").removeAttr("disabled");
                                    $("#role_dice").css("display", "block");
                                    $('#score').html("Please roll ...");
                                    now.distributeGamePlay(now.name + " starts the game by rolling the dice first, please wait till room is locked");
                                }
                                now.distributeGamePlay(load_msg);
                                refresh_users_list();
                                loadCB();
                            });
                        });

                    }
                });
            });

            // Receive messages from people in the same group
            now.receiveMessage = function(name, message){
                var color = "#" + ((1 << 24) * Math.random() | 0).toString(16);
                var new_message = '<b style= color:'+color+'>' + name + "</b>: " + message + "<br/>";
                var old_message = $("#messages").html();
                if(old_message != null)
                    new_message += old_message;
                // swap players here - killing the client side aaaargh
                if(message.indexOf("disconnected pa_index") != -1){
                    reset_player(message[message.indexOf("=") + 1]);
                }
                else
                    $("#messages").html(new_message);
            };

            // Receive messages from people in the same group
            var prev_message = "";
            now.receiveGamePlay = function(message){
                var new_message = "<span class='current_info'>" + message + "</span><br/>";
                var old_message = $("#game_play_info").html();
                if(old_message != null){
                    old_message = old_message.replace("current_info", "old_info");
                    new_message += old_message;
                }

                if(message.indexOf(prev_message) == -1){
                    $("#game_play_info").html(new_message);
                    if(message.indexOf("disconnected from Room") != -1 || message.indexOf("left the room") != -1){
                        refresh_users_list();
                    }
                }

                if(message.indexOf("joins the game") != -1)
                    refresh_users_list();

                var removed_user = message.substring(0, message.indexOf(" was removed"));
                if(removed_user == now.name){
                    alert("Oops... moderator has removed you from the game room");
                    window.location = "/";
                }

                // check dice enable
                var expr = now.name + "'s turn to play";
                if(message.indexOf("turn to play") != -1){
                    $('#dice_stack').html("");
                    if(message.indexOf(expr) != -1){
                        clear_values();
                        $('#role_dice').removeAttr("disabled");
                        $("#role_dice").css("display", "block");
                        $('#score').html("Please roll");
                    }else{
                        $('#role_dice').attr("disabled", "disabled");
                        $('#score').html("Wait for turn");
                    }
                }
                prev_message = message;
            };

            // Send messages to people in the same group
//            $("#send_message").submit(function(){
//                now.distributeMessage($("#text-input").val());
//                $("#text-input").val("");
//                return false;
//            });

            $("#pass_turn").live('click', function(){
                var con = confirm("Do you really want to Pass the turn ?")
                if(con == true){
                    clear_values();
                    now.turn_change();
                }
            });
        });
    </script>
</head>
<body>
<div id="popupContact">
    <div id="contactArea">
        <center><b>Loading Please wait ...</b></center>
    </div>
</div>
<div id="backgroundPopup"></div>

<div class="game_heading">
			<span style='float:left;font-family: chalkduster'>
				<font size='4'>
                    Chowka Bhara - ಚೌಕಬಾರ
                    <i>( Do not press Refresh or Back )</i>
                </font>
			</span>
			<span style='float:right; padding: 5px;'>
				<span id="menu" class='menu'>
					<span id='menu_messages'></span>
					<a class='menu_item' id='help_div' href='#' >Help</a> |
					<a class='menu_item' id='leave_room' href='#' >Leave Room</a>
					<span id="moderator_menu" class="moderator_menu">
						 | <a  class='menu_item' id='lock_room' href='#'>Lock Room</a>
						 | <a  class='menu_item' id='pass_turn' href='#'>Pass Turn</a>
						<span id='users_list'></span>
					</span>
				</span>
			</span>
</div>


<div id="holder" class="holder">

</div>

<br>

<div class="game_panel">
    <div id='game_play_info' class="game_play"></div>
    <div id='uuidDiv'></div>

</div>


<div class="button">
    <button id='role_dice' class="inset" disabled="disabled" onClick="javascript:play_game()">ROLL</button>
    <span id="score" class="score"></span>
    <p class='stack' id="dice_stack"></p>
</div>

</body>

<!-- shoutbox -->
<div class="shout_box">
    <div class="header">Chat <div class="close_btn">&nbsp;</div>
    </div>
    <div class="toggle_chat">
        <div class="message_box">
            <p id="messages"></p>
        </div>
        <div class="user_info">
            <input name="shout_message" id="shout_message" type="text" placeholder="Type Your Message Hit Enter" maxlength="100" />
        </div>

    </div>

</div>
<!-- shoutbox end -->


<script>


    //method to trigger when user hits enter key
    $("#shout_message").keypress(function(evt) {
        if(evt.which == 13) {
            var definition = {smile:{title:"Smile",codes:[":)",":=)",":-)"]},"sad-smile":{title:"Sad Smile",codes:[":(",":=(",":-("]},"big-smile":{title:"Big Smile",codes:[":D",":=D",":-D",":d",":=d",":-d"]},cool:{title:"Cool",codes:["8)","8=)","8-)","B)","B=)","B-)","(cool)"]},wink:{title:"Wink",codes:[":o",":=o",":-o",":O",":=O",":-O"]},crying:{title:"Crying",codes:[";(",";-(",";=("]},sweating:{title:"Sweating",codes:["(sweat)","(:|"]},speechless:{title:"Speechless",codes:[":|",":=|",":-|"]},kiss:{title:"Kiss",codes:[":*",":=*",":-*"]},"tongue-out":{title:"Tongue Out",codes:[":P",":=P",":-P",":p",":=p",":-p"]},blush:{title:"Blush",codes:["(blush)",":$",":-$",":=$",':">']},wondering:{title:"Wondering",codes:[":^)"]},sleepy:{title:"Sleepy",codes:["|-)","I-)","I=)","(snooze)"]},dull:{title:"Dull",codes:["|(","|-(","|=("]},"in-love":{title:"In love",codes:["(inlove)"]},"evil-grin":{title:"Evil grin",codes:["]:)",">:)","(grin)"]},talking:{title:"Talking",codes:["(talk)"]},yawn:{title:"Yawn",codes:["(yawn)","|-()"]},puke:{title:"Puke",codes:["(puke)",":&",":-&",":=&"]},"doh!":{title:"Doh!",codes:["(doh)"]},angry:{title:"Angry",codes:[":@",":-@",":=@","x(","x-(","x=(","X(","X-(","X=("]},"it-wasnt-me":{title:"It wasn't me",codes:["(wasntme)"]},party:{title:"Party!!!",codes:["(party)"]},worried:{title:"Worried",codes:[":S",":-S",":=S",":s",":-s",":=s"]},mmm:{title:"Mmm...",codes:["(mm)"]},nerd:{title:"Nerd",codes:["8-|","B-|","8|","B|","8=|","B=|","(nerd)"]},"lips-sealed":{title:"Lips Sealed",codes:[":x",":-x",":X",":-X",":#",":-#",":=x",":=X",":=#"]},hi:{title:"Hi",codes:["(hi)"]},call:{title:"Call",codes:["(call)"]},devil:{title:"Devil",codes:["(devil)"]},angel:{title:"Angel",codes:["(angel)"]},envy:{title:"Envy",codes:["(envy)"]},wait:{title:"Wait",codes:["(wait)"]},bear:{title:"Bear",codes:["(bear)","(hug)"]},"make-up":{title:"Make-up",codes:["(makeup)","(kate)"]},"covered-laugh":{title:"Covered Laugh",codes:["(giggle)","(chuckle)"]},"clapping-hands":{title:"Clapping Hands",codes:["(clap)"]},thinking:{title:"Thinking",codes:["(think)",":?",":-?",":=?"]},bow:{title:"Bow",codes:["(bow)"]},rofl:{title:"Rolling on the floor laughing",codes:["(rofl)"]},whew:{title:"Whew",codes:["(whew)"]},happy:{title:"Happy",codes:["(happy)"]},smirking:{title:"Smirking",codes:["(smirk)"]},nodding:{title:"Nodding",codes:["(nod)"]},shaking:{title:"Shaking",codes:["(shake)"]},punch:{title:"Punch",codes:["(punch)"]},emo:{title:"Emo",codes:["(emo)"]},yes:{title:"Yes",codes:["(y)","(Y)","(ok)"]},no:{title:"No",codes:["(n)","(N)"]},handshake:{title:"Shaking Hands",codes:["(handshake)"]},skype:{title:"Skype",codes:["(skype)","(ss)"]},heart:{title:"Heart",codes:["(h)","<3","(H)","(l)","(L)"]},"broken-heart":{title:"Broken heart",codes:["(u)","(U)"]},mail:{title:"Mail",codes:["(e)","(m)"]},flower:{title:"Flower",codes:["(f)","(F)"]},rain:{title:"Rain",codes:["(rain)","(london)","(st)"]},sun:{title:"Sun",codes:["(sun)"]},time:{title:"Time",codes:["(o)","(O)","(time)"]},music:{title:"Music",codes:["(music)"]},movie:{title:"Movie",codes:["(~)","(film)","(movie)"]},phone:{title:"Phone",codes:["(mp)","(ph)"]},coffee:{title:"Coffee",codes:["(coffee)"]},pizza:{title:"Pizza",codes:["(pizza)","(pi)"]},cash:{title:"Cash",codes:["(cash)","(mo)","($)"]},muscle:{title:"Muscle",codes:["(muscle)","(flex)"]},cake:{title:"Cake",codes:["(^)","(cake)"]},beer:{title:"Beer",codes:["(beer)"]},drink:{title:"Drink",codes:["(d)","(D)"]},dance:{title:"Dance",codes:["(dance)","\\o/","\\:D/","\\:d/"]},ninja:{title:"Ninja",codes:["(ninja)"]},star:{title:"Star",codes:["(*)"]},mooning:{title:"Mooning",codes:["(mooning)"]},finger:{title:"Finger",codes:["(finger)"]},bandit:{title:"Bandit",codes:["(bandit)"]},drunk:{title:"Drunk",codes:["(drunk)"]},smoking:{title:"Smoking",codes:["(smoking)","(smoke)","(ci)"]},toivo:{title:"Toivo",codes:["(toivo)"]},rock:{title:"Rock",codes:["(rock)"]},headbang:{title:"Headbang",codes:["(headbang)","(banghead)"]},bug:{title:"Bug",codes:["(bug)"]},fubar:{title:"Fubar",codes:["(fubar)"]},poolparty:{title:"Poolparty",codes:["(poolparty)"]},swearing:{title:"Swearing",codes:["(swear)"]},tmi:{title:"TMI",codes:["(tmi)"]},heidy:{title:"Heidy",codes:["(heidy)"]},myspace:{title:"MySpace",codes:["(MySpace)"]},malthe:{title:"Malthe",codes:["(malthe)"]},tauri:{title:"Tauri",codes:["(tauri)"]},priidu:{title:"Priidu",codes:["(priidu)"]}};
            emoticons.define(definition);
            value = $("#shout_message").val()
            now.distributeMessage(emoticons.replace(value));
            $("#shout_message").val("")
            return false;

        }
    });


    //toggle hide/show shout box
    $(".header").click(function (e) {
        var toggleState = $('.toggle_chat').css('display');
        $('.toggle_chat').slideToggle();
        if(toggleState == 'block')
        {
            $(".header div").attr('class', 'open_btn');
        }else{
            $(".header div").attr('class', 'close_btn');
        }
    });

</script>

</html>
